<button pButton label="New Group" icon="pi pi-plus" severity="info" class="p-button-primary w-full sm:w-auto"
    (click)="openNewGroupModal()"></button>
<p-dialog maskStyleClass="backdrop-blur-sm" header="Create New Group" [modal]="true" [(visible)]="visible">
    <div class="max-w-2xl mx-auto">
        <form [formGroup]="groupForm" (ngSubmit)="onSubmit()" class="space-y-6">
            <!-- Error messages -->
            <div *ngIf="formErrors.length > 0" class="bg-red-50 border border-red-200 rounded-md p-4 mb-4">
                <ul class="list-disc pl-5">
                    <li *ngFor="let error of formErrors" class="text-red-600 text-sm">{{ error }}</li>
                </ul>
            </div>

            <!-- Group Name -->
            <p-floatlabel variant="on" class="w-full mt-2">
                <input pInputText id="name" formControlName="name" class="w-full" />
                <label for="name">Group Name</label>
            </p-floatlabel>

            <!-- Group Description -->
            <p-floatlabel variant="on" class="w-full mt-2">
                <textarea pTextarea id="description" formControlName="description" class="w-full" rows="3"></textarea>
                <label for="description">Description</label>
            </p-floatlabel>

            <!-- Group Poster Image -->
            <div class="mt-4">
                <div class="flex items-center gap-4">

                    <p-fileUpload #fileUpload mode="basic" [auto]="true" chooseLabel="Choose group photo" chooseIcon="pi pi-upload" variant="text" accept="image/*"
                        [maxFileSize]="1000000" (onSelect)="onImageSelect($event)" [showCancelButton]="false"
                        pTooltip="Max file size: 1MB. Supported formats: JPG, PNG" tooltipPosition="right"
                        placeholder="Right">
                    </p-fileUpload>

                    <!-- Image Preview -->
                    <div *ngIf="selectedImage" class="relative">
                        <img [src]="selectedImage" class="h-24 w-24 object-cover rounded-lg border">
                        <button type="button" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1"
                            (click)="removeImage()">
                            <i class="pi pi-times"></i>
                        </button>
                    </div>
                </div>
                <!-- <input type="text" pInputText pTooltip="Max file size: 1MB. Supported formats: JPG, PNG" tooltipPosition="bottom" placeholder="Bottom" /> -->

            </div>

            <!-- Members Section -->
            <div class="mt-6">
                <h1 class="text-lg font-bold text-gray-750">Group Members</h1>

                <!-- Current User Card -->
                <div *ngIf="currentUser" class="p-1 rounded-lg cursor-pointer hover:bg-[var(--surface-hover)]">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-full bg-blue-200 flex items-center justify-center">
                            <i class="pi pi-user text-blue-600"></i>
                        </div>
                        <div>
                            <p class="text-lg mb-0">You</p>
                            <p class="text-sm text-blue-600">{{ currentUser.email }}</p>
                        </div>
                    </div>
                </div>

                <!-- Other Members -->
                <div formArrayName="members" class="space-y-4">
                    <div *ngFor="let member of members.controls; let i = index" [formGroupName]="i"
                        class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
                        <!-- Skip the first member as it's the current user -->
                        <ng-container *ngIf="i > 0">
                            <!-- Member Name -->
                            <p-floatlabel variant="on" class="w-full">
                                <input pInputText [id]="'memberName' + i" type="text" formControlName="name" class="w-full"
                                    [ngClass]="{'border-red-300': isArrayFieldInvalid(i, 'name')}" />
                                <label [for]="'memberName' + i">Member Name</label>
                            </p-floatlabel>

                            <!-- Member Email -->
                            <p-floatlabel variant="on" class="w-full">
                                <input pInputText [id]="'memberEmail' + i" type="email" formControlName="email"
                                    class="w-full" [ngClass]="{'border-red-300': isArrayFieldInvalid(i, 'email')}" />
                                <label [for]="'memberEmail' + i">Member Email</label>
                            </p-floatlabel>

                            <!-- Remove Button -->
                            <button type="button" (click)="removeMember(i)"
                                class="mt-1 text-red-600 hover:text-red-800">
                                <i class="pi pi-trash" style="font-size: 1.1rem"></i>
                            </button>
                        </ng-container>
                    </div>
                </div>

                <!-- Add Member Button -->
                <p-button label="Add a person" icon="pi pi-plus" variant="text" severity="secondary" styleClass="mt-5"
                    (click)="addMember()" [disabled]="members.length >= 10" />
            </div>

            <!-- Submit Button -->
            <div class="flex justify-end">
                <p-button type="submit" label="Create Group" [disabled]="!groupForm.valid || isSubmitting"
                    severity="warn"></p-button>
            </div>
        </form>
    </div>
</p-dialog>
